## Filtering the VCF

# The resulting VCF produced above will include any variable sites in the alignment. Many of these will not meet our cutoff criteria (e.g those likely caused by mapping or sequencing errors) and thus must be removed before any genetic analysis is attempted. The easiest way to achieve this is to use VCFtools.

# VCFtools is a bash program that can be run on the command line (and installed on MAC iOS via homebrew - `brew install vcftools` ).

# For this analysis the reference genome is removed (to avoid duplication effects) and the minor allele frequency is set to 0.005. 

# set the working directory to the folder with vcf files
cd <path/to/vcfs

# remove the reference individual: 
vcftools --vcf snp_sites_msa_filtered_converted_09_2023.vcf --remove-indv NC_012920.1 --recode --out snp_sites_filtered_vcf_noRef_092023

# create a new VCF with a MAF of 0.005 
vcftools --vcf snp_sites_filtered_vcf_noRef_092023.recode.vcf --maf 0.005 --recode --out snp_sites_filtered_vcf_maf0.005_noRef_092023

# This results in a VCF file with 442 sites (of an original 7254) and 23,790 individuals.
# This is the file that will be used going forwards.

## Generating allele frequency information

# VCFtools can also be used to calculate allele frequencies and missing data proportions. These can be used as a useful sanity check for the data.

# *Note: the maximum number of alleles here is 3 (not the typical 2) - each of
these will still meet the minimum allele frequency specified above.*

# calculate the allele frequencies:
vcftools --vcf snp_sites_filtered_vcf_maf0.005_noRef_092023.recode.vcf --freq --out ./lhf_allele_freq_122023 --max-alleles 3

# calculate the proportion of missing data (where no informative information is available)

# per site: 
vcftools --vcf snp_sites_filtered_vcf_maf0.005_092023.recode.vcf --missing-site --out ./missing_site

# per individual
vcftools --vcf snp_sites_filtered_vcf_maf0.005_092023.recode.vcf --missing-indv --out ./missing_indv
